version: 2.1

executors:
  arm64:
    machine:
      image: ubuntu-2204:2024.01.1
      # The same volume is set for amd64 and arm64.
      # see https://circleci.com/docs/2.0/docker-layer-caching/
      docker_layer_caching: false
    resource_class: arm.medium
  x86_64:
    machine:
      image: ubuntu-2204:2024.01.1
      # The same volume is set for amd64 and arm64.
      # see https://circleci.com/docs/2.0/docker-layer-caching/
      docker_layer_caching: false
    resource_class: large

jobs:
  test:
    parameters:
      arch:
        type: executor
    executor: << parameters.arch >>
    environment:
      - CIRCLECI_WORKSPACE: /home/circleci/project
    steps:
      - checkout
      - run: docker version
      - run:
          name: Install buildx
          command: |
            docker buildx install
            docker run --privileged --rm tonistiigi/binfmt:qemu-v7.0.0-28 --install "$BUILDX_PLATFORMS"
            docker buildx create --name malti-arch --use
            docker buildx ls
      - run: make ci:diff
      - run:
          command: |
            ARCH=`make arch`
            EXTENSION=`make extension`

            make ci:diff | while read DIR; do
              cd ${CIRCLECI_WORKSPACE}/${DIR}
              if find . -type l -o -type f -name "Dockerfile${EXTENSION}" | grep Dockerfile ; then
                make build;
                make test;
              else
                echo "${DIR} is ${ARCH} not supported. make build & make test was skipped.";
              fi
            done

      - run:
          name: Notification failed
          command: |
            if [ "${CIRCLE_PR_USERNAME}" == "cw-circleci" ]; then
              make ci:notify -e TITLE="CircleCI: Failed to CI of PR created by automatic update of dependency (devil) arch: $(make arch)" \
                        -e BODY="${CIRCLE_PULL_REQUEST}";
            fi
          when: on_fail

workflows:
  version: 2
  integration:
    jobs:
      - test:
          context: "chatwork_api_token@circleci"
          # see https://circleci.com/docs/2.0/configuration-reference/#matrix-requires-version-21
          matrix:
            parameters:
              arch: [ x86_64, arm64 ]
